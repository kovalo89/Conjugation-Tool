<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conjugador Franc√©s</title>
  <style>
    :root {
      --bg: #0d1117;
      --card: #0f1724;
      --primary: #ffffff;
      --fuchsia: #ff49c8;
      --success: #13f898;
      --muted: #c8d6e6;
      --modeTitle: #0091ff;
      --pronoMuted: #accdf3ba;
      --border: #576d7f;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: var(--bg);
      color: #e6eef8;
      font-family: Roboto, system-ui, Roboto, Roboto, "Roboto", Roboto;
      min-height: 100vh
    }

    .container {
      max-width: 980px;
      margin: 32px auto;
      padding: 20px
    }

    .header {
      text-align: center;
      margin-bottom: 18px
    }

    h1 {
      color: var(--primary);
      margin: 0 0 16px;
      font-size: 22px;
      letter-spacing: 0.5px;
    }

    .mode-tabs {
      display: inline-flex;
      gap: 12px
    }

    .tab {
      background: var(--card);
      padding: 8px 18px;
      border-radius: 10px;
      border: 1px solid var(--border);
      color: var(--muted);
      cursor: pointer;
      font-weight: 700
    }

    .tab.active {
      background: linear-gradient(180deg, #0d87fa, #01287c);
      color: var(--primary)
    }

    .card {
      background: var(--card);
      max-width: 600px;
      margin: 0 auto;
      border-radius: 14px;
      padding: 20px 20px;
      border: 1px solid var(--border);
      margin-bottom: 14px;
      position: relative;
    }

    .section-title {
      justify-self: center;
      color: var(--primary);
      text-align: center;
      font-weight: 700;
      margin-bottom: 15px
    }

    .chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .chip {
      padding: 8px 14px;
      border-radius: 7px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--border);
      cursor: pointer;
      color: var(--muted);
      font-size: 14px;
      font-weight: 100
    }

    .chip:hover {
      background: rgba(107, 193, 255, 0.128)
    }

    .chip.selected {
      background: rgba(88, 166, 255, 0.147);
      border-color: rgb(0, 174, 255);
      color: var(--primary);
      box-shadow: 0 8px 20px rgba(88, 166, 255, 0.06)
    }


    .exercise-wrap {
      margin-top: 10px
    }

    .question {
      font-size: 16px;
      margin-bottom: 6px
    }

    .sub {
      color: var(--muted);
      margin-bottom: 16px
    }

    #questionAleatorio,

    #pronounAleatorio {
      text-align: center;
    }

    .input-row {
      display: flex;
      justify-content: center;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .input-buttons {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      align-items: center;
      position: relative;
      border-color: #ff6b6b;
      gap: 14px;
    }


    .input {
      min-width: 100px;
      width: 200px;
      height: 44px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #071018;
      color: #ffffff;
      font-size: 16px;
      text-align: center;
    }

    .inputIndi.correctIndi {
      border-color: var(--success);
      box-shadow: 0 10px 30px rgba(31, 196, 127, 0.08)
    }

    .inputIndi.wrongIndi {
      border-color: var(--fuchsia);
      animation: shake .45s
    }



    .input.correct {
      border-color: var(--success);
      box-shadow: 0 10px 30px rgba(31, 196, 127, 0.08)
    }

    .input.wrong {
      border-color: var(--fuchsia);
      animation: shake .45s
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0)
      }

      25% {
        transform: translateX(-8px)
      }

      75% {
        transform: translateX(8px)
      }
    }


    /* buttons */
    .icon-btn {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: inline-grid;
      place-items: center;
      border: none;
      cursor: pointer;
      box-shadow: 0 12px 32px rgba(2, 6, 23, 0.6)
    }

    .btn-orange {
      background: linear-gradient(180deg, #58a6ff, #2b82e6);
      border: none;
    }

    .btn-pink {
      background: linear-gradient(180deg, #ff6adf, #ff49c8);
      width: 44px;
      height: 44px;
      border-radius: 10px;
      border: none;

    }

    .btn-pink:hover {
      filter: brightness(1.25);
    }

    .btn-blue[disabled],

    .btn-blue[disabled]:hover {
      /* Mute the background gradient */
      background: linear-gradient(180deg, #576d7f, #3a4b5b);
      /* Slightly lighten the content */
      opacity: 0.6;
      /* Ensure cursor shows it's disabled */
      cursor: not-allowed;
      /* Remove hover filter if present */
      filter: none;
    }

    .btn-green {
      background: linear-gradient(180deg, #33e59f, #1fc47f);
      width: 44px;
      height: 44px;
      border-radius: 10px;
      border: none;
    }

    .btn-green:hover {
      filter: brightness(1.25);
    }

    .btn-red {
      background: linear-gradient(180deg, #ff6b6b, #ff3b3b);
      width: 44px;
      height: 44px;
      border-radius: 10px;
      border: none;
    }

    .btn-red:hover {
      filter: brightness(1.25);
    }

    .btn-blue {
      background: linear-gradient(180deg, #58a6ff, #2b82e6);
      width: 44px;
      height: 44px;
      border-radius: 10px;
      border: none;
    }

    .btn-blue:hover {
      filter: brightness(1.25);
    }

    .topBackPosition {
      display: flex;
      justify-content: center;
    }

    .inline-actions {
      display: flex;
      flex-direction: row;
      gap: 14px;
      justify-content: center;
      align-content: center;
    }

    /* pronouns */

    .pronoms {
      max-width: 820px;
      margin: 8px auto 0
    }

    .pronom-row {
      position: relative;
      display: grid;
      grid-template-columns:
        auto minmax(80px, 90px) 200px minmax(80px, 90px) auto;
      width: 100%;
      margin: 10px auto;
    }

    .inputIndi {
      grid-column: 3;
      grid-row: 1;
      justify-self: center;
      align-self: center;
      width: 200px;
      height: 44px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #071018;
      color: #ffffff;
      font-size: 16px;
      text-align: center;
    }

    .pronom {
      grid-column: 2;
      grid-row: 1;
      text-align: right;
      align-self: center;
      margin-right: 15px;
      color: var(--pronoMuted);
    }


    .mutedWords {
      color: var(--pronoMuted);
    }



    .pronomAl {
      display: flex;
      justify-content: center;
      color: var(--pronoMuted);
    }

    .small-reveal {
      padding: 8px 10px;
      border-radius: 10px;
      border: none;
      background: rgba(255, 255, 255, 0.03);
      cursor: pointer;
      color: var(--muted)
    }

    /* back button in exercise header */
    .exercise-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px
    }

    .back-btn {
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-weight: 700;
      padding: 8px 10px;
      border-radius: 10px
    }

    .hidden {
      display: none
    }

    .quickCenter {
      display: flex;
      justify-content: center;
      align-content: center;
    }

    .indivCenter {
      display: flex;
      justify-content: space-between;
    }

    /* footer */
    footer {
      text-align: center;
      margin-top: 26px;
      color: var(--muted);
      font-size: 13px
    }

    .mobile-error-overlay .close {
      float: right;
      color: white;
      opacity: 0.95;
      cursor: pointer;
      padding-left: 8px;
      font-weight: 700
    }

    /* DROPDOWN ARROW Design */
    .custom-select {
      appearance: none;
      -webkit-appearance: none;
      background-color: #06121a;
      color: #ffffff;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      width: 200px;
      position: relative;
      text-align: center;
      font-size: 14px;
    }

    .custom-select-wrapper {
      position: relative;
      display: inline-block;
    }

    .custom-select-arrow {
      position: absolute;
      right: 15px;
      /* ‚Üê CHANGE THIS TO MOVE ARROW */
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      font-size: .75rem;
      color: #78869e;
    }

    /* Mobile fix: move buttons below input */
    @media (max-width: 720px) {
      .input-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      /* #answer.input {
        width: 100%;
        /* bigger input on mobile */
    }

    .inviBtn-Style {
      background-color: #0091ff;
      width: 44px;
      height: 44px;
    }

    .header-control-row {
      display: flex;
      justify-content: center;
      align-items: center;
      max-width: 600px;
      margin: auto;
      gap: 20px;
    }

    #topBack {
      background: linear-gradient(180deg, #58a6ff, #2b82e6);
      border: 5px;
      padding: 10px 12px;
      border-radius: 10px;
    }

    #individualTitle {
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">

      <h1><span style="font-size: 30px;">üá´üá∑</span><br>Conjugador de Franc√©s</h1>
      <div class="header-control-row hidden">
        <button id="topBack" class="hidden" onclick="goBack()">
          <svg width="25" height="25" viewBox="0 0 24 24" fill="none">
            <path d="M15 6l-6 6 6 6" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
          </svg>
        </button>
        <!-- <div id="inviBtn" class="inviBtn-Style hidden">
        </div> -->
      </div>
      <div class="mode-tabs">
        <div class="tab active" id="tab-ale" onclick="showMode('aleatorio')">Aleatorio</div>
        <div class="tab" id="tab-ind" onclick="showMode('individual')">Individual</div>
      </div>
    </div>

    <!-- SETUP VIEW (Aleatorio / Individual) -->
    <div id="setupView">
      <!-- ALEATORIO MODE SETUP -->
      <div id="aleatorioPanel">
        <div class="card">
          <div class="section-title">Tiempos a practicar:</div>
          <div class="chips" id="tenseChips"></div>
        </div>

        <div class="card">
          <div class="section-title">Verbos a incluir:</div>
          <div class="chips" id="verbChips"></div>
        </div>
        <div style="text-align:center;margin-top:8px;display:flex;justify-content:center;gap:12px;align-items:center">
          <button id="clearAleatorio" class="btn-red hidden" onclick="clearAleatorio()" title="Borrar selecciones"
            aria-label="Borrar selecciones">
            <img src="https://raw.githubusercontent.com/kovalo89/Conjugation-Tool/main/Icons/trash.png" width="20px"
              height="20px" alt="Borrar">
          </button>
          <button id="startAleatorio" class="btn-blue hidden" onclick="startAleatorio()" disabled>
            <img src="https://raw.githubusercontent.com/kovalo89/Conjugation-Tool/main/Icons/start.png" width="20px"
              height="20px" alt="Borrar" alt="Iniciar">
          </button>
        </div>
      </div>

      <!-- INDIVIDUAL MODE SETUP -->
      <div id="individualPanel" class="hidden">
        <div class="card">
          <div class="section-title">Selecciona un verbo</div>
          <div style="display: flex; justify-content:center; margin:auto;">
            <div class="custom-select-wrapper">
              <select id="singleVerb" class="custom-select">
                <option value="">Elige un verbo...</option>
              </select>
              <div class="custom-select-arrow">‚ñº</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="section-title">Tiempos a practicar</div>
          <div class="chips" id="individualTenseChips"></div>
        </div>
        <div style="text-align:center;margin-top:8px;display:flex;justify-content:center;gap:12px;align-items:center">
          <button id="clearIndividual" class="btn-red hidden" onclick="clearIndividual()" title="Borrar selecciones"
            aria-label="Borrar selecciones">
            <img src="https://raw.githubusercontent.com/kovalo89/Conjugation-Tool/main/Icons/trash.png" width="20px"
              height="20px" alt="Borrar">
          </button>
          <button id="startIndividual" class="btn-blue hidden" onclick="startIndividual()" disabled>
            <img src="https://raw.githubusercontent.com/kovalo89/Conjugation-Tool/main/Icons/start.png" width="20px"
              height="20px" alt="Borrar" alt="Iniciar">
          </button>
        </div>
      </div>
    </div>

    <!-- EXERCISE VIEW -->
    <div id="exerciseView" class="hidden">

      <!-- <div id="exerciseModeLabel" style="color:var(--muted);font-weight:100;display:none"></div> -->
      <div class="card">
        <div class="exercise-header">
        </div>

        <!-- ALEATORIO EXERCISE -->
        <div id="aleatorioExercise" class="hidden">
          <div id="aleModeBanner"
            style="color:var(--modeTitle);font-weight:600;font-size: 20px;margin-bottom: 10px; text-align: center;">
          </div>

          <div class="question" id="questionAleatorio"></div>
          <div class="sub" id="pronounAleatorio"></div>

          <div class="input-row">
            <!-- INVISIBLE BUTTON -->
            <!-- <div class="input-buttons">
              <div id="inviBtn01" class="inviBtn-Style hidden"></div>
              <div id="inviBtn02" class="inviBtn-Style hidden"></div>
            </div> -->
            <!-- INPUT ROW -->
            <input id="answer" class="input" placeholder="Escribe la respuesta..." autocomplete="off">
            <!-- BUTTONS -->
            <div class="input-buttons">
              <button id="btnRevealAleatorio" class="icon-btn btn-pink" title="Revelar todo">
                <svg width="26" height="26" viewBox="0 0 24 24" aria-hidden>
                  <circle cx="11" cy="11" r="6" stroke="white" stroke-width="3" fill="none" />
                  <path d="M21 21l-4.35-4.35" stroke="white" stroke-width="3" stroke-linecap="round"
                    stroke-linejoin="round" fill="none" />
                </svg>
              </button>
              <button id="btnCheck" class="btn-blue hidden">
                <img src="https://raw.githubusercontent.com/kovalo89/Conjugation-Tool/main/Icons/start.png" width="20px"
                  height="20px" alt="Borrar" alt="Iniciar">
              </button>
              <button class="icon-btn btn-green hidden" id="btnNext" title="Siguiente" onclick="nextAleatorio()">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="white" aria-hidden>
                  <path d="M5 4v16l14-8z" />
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- INDIVIDUAL EXERCISE -->
        <div id="individualExercise" class="hidden">
          <div id="indivModeBanner"
            style="color:var(--modeTitle);font-weight:600;font-size: 20px;margin-bottom: 10px; text-align: center;">
          </div>

          <div class="question" id="individualTitle"></div>
          <div class="pronoms" id="pronomsList"></div>

          <div class="inline-actions">
            <button id="btnRevealIndividual" class="icon-btn btn-pink" title="Revelar todo">
              <svg width="26" height="26" viewBox="0 0 24 24" aria-hidden>
                <circle cx="11" cy="11" r="6" stroke="white" stroke-width="3" fill="none" />
                <path d="M21 21l-4.35-4.35" stroke="white" stroke-width="3" stroke-linecap="round"
                  stroke-linejoin="round" fill="none" />
              </svg>
            </button>
            <button id="btnCheckIndividual" class="btn-blue" disabled>
              <img src="https://raw.githubusercontent.com/kovalo89/Conjugation-Tool/main/Icons/start.png" width="20px"
                height="20px" alt="Iniciar">
            </button>

            <button class="icon-btn btn-green hidden" id="btnNextIndividual" title="Siguiente tiempo"
              onclick="nextIndividual()">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="white" aria-hidden>
                <path d="M5 4v16l14-8z" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- <footer>Conjugador Franc√©s PRO ‚Ä¢ 100% offline ‚Ä¢ Hecho con cari√±o</footer> -->
  </div>



  <script>
    // ------------------------------
    // Data (same as before, corrected)
    window.conjugations = {
      √ätre: { present: ["suis", "es", "est", "sommes", "√™tes", "sont"], passeCompose: ["ai √©t√©", "as √©t√©", "a √©t√©", "avons √©t√©", "avez √©t√©", "ont √©t√©"], imparfait: ["√©tais", "√©tais", "√©tait", "√©tions", "√©tiez", "√©taient"], futurSimple: ["serai", "seras", "sera", "serons", "serez", "seront"], plusQueParfait: ["avais √©t√©", "avais √©t√©", "avait √©t√©", "avions √©t√©", "aviez √©t√©", "avaient √©t√©"], futurProche: ["vais √™tre", "vas √™tre", "va √™tre", "allons √™tre", "allez √™tre", "vont √™tre"], futurAnterieur: ["aurai √©t√©", "auras √©t√©", "aura √©t√©", "aurons √©t√©", "aurez √©t√©", "auront √©t√©"] },
      Avoir: { present: ["ai", "as", "a", "avons", "avez", "ont"], passeCompose: ["ai eu", "as eu", "a eu", "avons eu", "avez eu", "ont eu"], imparfait: ["avais", "avais", "avait", "avions", "aviez", "avaient"], futurSimple: ["aurai", "auras", "aura", "aurons", "aurez", "auront"], plusQueParfait: ["avais eu", "avais eu", "avait eu", "avions eu", "aviez eu", "avaient eu"], futurProche: ["vais avoir", "vas avoir", "va avoir", "allons avoir", "allez avoir", "vont avoir"], futurAnterieur: ["aurai eu", "auras eu", "aura eu", "aurons eu", "aurez eu", "auront eu"] },
      Faire: { present: ["fais", "fais", "fait", "faisons", "faites", "font"], passeCompose: ["ai fait", "as fait", "a fait", "avons fait", "avez fait", "ont fait"], imparfait: ["faisais", "faisais", "faisait", "faisions", "faisiez", "faisaient"], futurSimple: ["ferai", "feras", "fera", "ferons", "ferez", "feront"], plusQueParfait: ["avais fait", "avais fait", "avait fait", "avions fait", "aviez fait", "avaient fait"], futurProche: ["vais faire", "vas faire", "va faire", "allons faire", "allez faire", "vont faire"], futurAnterieur: ["aurai fait", "auras fait", "aura fait", "aurons fait", "aurez fait", "auront fait"] },
      Aller: { present: ["vais", "vas", "va", "allons", "allez", "vont"], passeCompose: ["suis all√©", "es all√©", "est all√©", "sommes all√©s", "√™tes all√©s", "sont all√©s"], imparfait: ["allais", "allais", "allait", "allions", "alliez", "allaient"], futurSimple: ["irai", "iras", "ira", "irons", "irez", "iront"], plusQueParfait: ["√©tais all√©", "√©tais all√©", "√©tait all√©", "√©tions all√©s", "√©tiez all√©s", "√©taient all√©s"], futurProche: ["vais aller", "vas aller", "va aller", "allons aller", "allez aller", "vont aller"], futurAnterieur: ["serai all√©", "seras all√©", "sera all√©", "serons all√©s", "serez all√©s", "seront all√©s"] },
      Pouvoir: { present: ["peux", "peux", "peut", "pouvons", "pouvez", "peuvent"], passeCompose: ["ai pu", "as pu", "a pu", "avons pu", "avez pu", "ont pu"], imparfait: ["pouvais", "pouvais", "pouvait", "pouvions", "pouviez", "pouvaient"], futurSimple: ["pourrai", "pourras", "pourra", "pourrons", "pourrez", "pourront"], plusQueParfait: ["avais pu", "avais pu", "avait pu", "avions pu", "aviez pu", "avaient pu"], futurProche: ["vais pouvoir", "vas pouvoir", "va pouvoir", "allons pouvoir", "allez pouvoir", "vont pouvoir"], futurAnterieur: ["aurai pu", "auras pu", "aura pu", "aurons pu", "aurez pu", "auront pu"] },
      Vouloir: { present: ["veux", "veux", "veut", "voulons", "voulez", "veulent"], passeCompose: ["ai voulu", "as voulu", "a voulu", "avons voulu", "avez voulu", "ont voulu"], imparfait: ["voulais", "voulais", "voulait", "voulions", "vouliez", "voulaient"], futurSimple: ["voudrai", "voudras", "voudra", "voudrons", "voudrez", "voudront"], plusQueParfait: ["avais voulu", "avais voulu", "avait voulu", "avions voulu", "aviez voulu", "avaient voulu"], futurProche: ["vais vouloir", "vas vouloir", "va vouloir", "allons vouloir", "allez vouloir", "vont vouloir"], futurAnterieur: ["aurai voulu", "auras voulu", "aura voulu", "aurons voulu", "aurez voulu", "auront voulu"] },
      Dire: { present: ["dis", "dis", "dit", "disons", "dites", "disent"], passeCompose: ["ai dit", "as dit", "a dit", "avons dit", "avez dit", "ont dit"], imparfait: ["disais", "disais", "disait", "disions", "disiez", "disaient"], futurSimple: ["dirai", "diras", "dira", "dirons", "direz", "diront"], plusQueParfait: ["avais dit", "avais dit", "avait dit", "avions dit", "aviez dit", "avaient dit"], futurProche: ["vais dire", "vas dire", "va dire", "allons dire", "allez dire", "vont dire"], futurAnterieur: ["aurai dit", "auras dit", "aura dit", "aurons dit", "aurez dit", "auront dit"] },
      Prendre: { present: ["prends", "prends", "prend", "prenons", "prenez", "prennent"], passeCompose: ["ai pris", "as pris", "a pris", "avons pris", "avez pris", "ont pris"], imparfait: ["prenais", "prenais", "prenait", "prenions", "preniez", "prenaient"], futurSimple: ["prendrai", "prendras", "prendra", "prendrons", "prendrez", "prendront"], plusQueParfait: ["avais pris", "avais pris", "avait pris", "avions pris", "aviez pris", "avaient pris"], futurProche: ["vais prendre", "vas prendre", "va prendre", "allons prendre", "allez prendre", "vont prendre"], futurAnterieur: ["aurai pris", "auras pris", "aura pris", "aurons pris", "aurez pris", "auront pris"] },
      Voir: { present: ["vois", "vois", "voit", "voyons", "voyez", "voient"], passeCompose: ["ai vu", "as vu", "a vu", "avons vu", "avez vu", "ont vu"], imparfait: ["voyais", "voyais", "voyait", "voyions", "voyiez", "voyaient"], futurSimple: ["verrai", "verras", "verra", "verrons", "verrez", "verront"], plusQueParfait: ["avais vu", "avais vu", "avait vu", "avions vu", "aviez vu", "avaient vu"], futurProche: ["vais voir", "vas voir", "va voir", "allons voir", "allez voir", "vont voir"], futurAnterieur: ["aurai vu", "auras vu", "aura vu", "aurons vu", "aurez vu", "auront vu"] },
      Savoir: { present: ["sais", "sais", "sait", "savons", "savez", "savent"], passeCompose: ["ai su", "as su", "a su", "avons su", "avez su", "ont su"], imparfait: ["savais", "savais", "savait", "savions", "saviez", "savaient"], futurSimple: ["saurai", "sauras", "saura", "saurons", "saurez", "sauront"], plusQueParfait: ["avais su", "avais su", "avait su", "avions su", "aviez su", "avaient su"], futurProche: ["vais savoir", "vas savoir", "va savoir", "allons savoir", "allez savoir", "vont savoir"], futurAnterieur: ["aurai su", "auras su", "aura su", "aurons su", "aurez su", "auront su"] },
      Venir: { present: ["viens", "viens", "vient", "venons", "venez", "viennent"], passeCompose: ["suis venu", "es venu", "est venu", "sommes venus", "√™tes venus", "sont venus"], imparfait: ["venais", "venais", "venait", "venions", "veniez", "venaient"], futurSimple: ["viendrai", "viendras", "viendra", "viendrons", "viendrez", "viendront"], plusQueParfait: ["√©tais venu", "√©tais venu", "√©tait venu", "√©tions venus", "√©tiez venus", "√©taient venus"], futurProche: ["vais venir", "vas venir", "va venir", "allons venir", "allez venir", "vont venir"], futurAnterieur: ["serai venu", "seras venu", "sera venu", "serons venus", "serez venus", "seront venus"] },
      Devoir: { present: ["dois", "dois", "doit", "devons", "devez", "doivent"], passeCompose: ["ai d√ª", "as d√ª", "a d√ª", "avons d√ª", "avez d√ª", "ont d√ª"], imparfait: ["devais", "devais", "devait", "devions", "deviez", "devaient"], futurSimple: ["devrai", "devras", "devra", "devrons", "devrez", "devront"], plusQueParfait: ["avais d√ª", "avais d√ª", "avait d√ª", "avions d√ª", "aviez d√ª", "avaient d√ª"], futurProche: ["vais devoir", "vas devoir", "va devoir", "allons devoir", "allez devoir", "vont devoir"], futurAnterieur: ["aurai d√ª", "auras d√ª", "aura d√ª", "aurons d√ª", "aurez d√ª", "auront d√ª"] },
      Boire: { present: ["bois", "bois", "boit", "buvons", "buvez", "boivent"], passeCompose: ["ai bu", "as bu", "a bu", "avons bu", "avez bu", "ont bu"], imparfait: ["buvais", "buvais", "buvait", "buvions", "buviez", "buvaient"], futurSimple: ["boirai", "boiras", "boira", "boirons", "boirez", "boiront"], plusQueParfait: ["avais bu", "avais bu", "avait bu", "avions bu", "aviez bu", "avaient bu"], futurProche: ["vais boire", "vas boire", "va boire", "allons boire", "allez boire", "vont boire"], futurAnterieur: ["aurai bu", "auras bu", "aura bu", "aurons bu", "aurez bu", "auront bu"] },
      Lire: { present: ["lis", "lis", "lit", "lisons", "lisez", "lisent"], passeCompose: ["ai lu", "as lu", "a lu", "avons lu", "avez lu", "ont lu"], imparfait: ["lisais", "lisais", "lisait", "lisions", "lisiez", "lisaient"], futurSimple: ["lirai", "liras", "lira", "lirons", "lirez", "liront"], plusQueParfait: ["avais lu", "avais lu", "avait lu", "avions lu", "aviez lu", "avaient lu"], futurProche: ["vais lire", "vas lire", "va lire", "allons lire", "allez lire", "vont lire"], futurAnterieur: ["aurai lu", "auras lu", "aura lu", "aurons lu", "aurez lu", "auront lu"] },
      √âcrire: { present: ["√©cris", "√©cris", "√©crit", "√©crivons", "√©crivez", "√©crivent"], passeCompose: ["ai √©crit", "as √©crit", "a √©crit", "avons √©crit", "avez √©crit", "ont √©crit"], imparfait: ["√©crivais", "√©crivais", "√©crivait", "√©crivions", "√©criviez", "√©crivaient"], futurSimple: ["√©crirai", "√©criras", "√©crira", "√©crirons", "√©crirez", "√©criront"], plusQueParfait: ["avais √©crit", "avais √©crit", "avait √©crit", "avions √©crit", "aviez √©crit", "avaient √©crit"], futurProche: ["vais √©crire", "vas √©crire", "va √©crire", "allons √©crire", "allez √©crire", "vont √©crire"], futurAnterieur: ["aurai √©crit", "auras √©crit", "aura √©crit", "aurons √©crit", "aurez √©crit", "auront √©crit"] },
      Parler: { present: ["parle", "parles", "parle", "parlons", "parlez", "parlent"], passeCompose: ["ai parl√©", "as parl√©", "a parl√©", "avons parl√©", "avez parl√©", "ont parl√©"], imparfait: ["parlais", "parlais", "parlait", "parlions", "parliez", "parlaient"], futurSimple: ["parlerai", "parleras", "parlera", "parlerons", "parlerez", "parleront"], plusQueParfait: ["avais parl√©", "avais parl√©", "avait parl√©", "avions parl√©", "aviez parl√©", "avaient parl√©"], futurProche: ["vais parler", "vas parler", "va parler", "allons parler", "allez parler", "vont parler"], futurAnterieur: ["aurai parl√©", "auras parl√©", "aura parl√©", "aurons parl√©", "aurez parl√©", "auront parl√©"] },
      Manger: { present: ["mange", "manges", "mange", "mangeons", "mangez", "mangent"], passeCompose: ["ai mang√©", "as mang√©", "a mang√©", "avons mang√©", "avez mang√©", "ont mang√©"], imparfait: ["mangeais", "mangeais", "mangeait", "mangions", "mangiez", "mangeaient"], futurSimple: ["mangerai", "mangeras", "mangera", "mangerons", "mangerez", "mangeront"], plusQueParfait: ["avais mang√©", "avais mang√©", "avait mang√©", "avions mang√©", "aviez mang√©", "avaient mang√©"], futurProche: ["vais manger", "vas manger", "va manger", "allons manger", "allez manger", "vont manger"], futurAnterieur: ["aurai mang√©", "auras mang√©", "aura mang√©", "aurons mang√©", "aurez mang√©", "auront mang√©"] },
      Finir: { present: ["finis", "finis", "finit", "finissons", "finissez", "finissent"], passeCompose: ["ai fini", "as fini", "a fini", "avons fini", "avez fini", "ont fini"], imparfait: ["finissais", "finissais", "finissait", "finissions", "finissiez", "finissaient"], futurSimple: ["finirai", "finiras", "finira", "finirons", "finirez", "finiront"], plusQueParfait: ["avais fini", "avais fini", "avait fini", "avions fini", "aviez fini", "avaient fini"], futurProche: ["vais finir", "vas finir", "va finir", "allons finir", "allez finir", "vont finir"], futurAnterieur: ["aurai fini", "auras fini", "aura fini", "aurons fini", "aurez fini", "auront fini"] },
      Partir: { present: ["pars", "pars", "part", "partons", "partez", "partent"], passeCompose: ["suis parti", "es parti", "est parti", "sommes partis", "√™tes partis", "sont partis"], imparfait: ["partais", "partais", "partait", "partions", "partiez", "partaient"], futurSimple: ["partirai", "partiras", "partira", "partirons", "partirez", "partiront"], plusQueParfait: ["√©tais parti", "√©tais parti", "√©tait parti", "√©tions partis", "√©tiez partis", "√©taient partis"], futurProche: ["vais partir", "vas partir", "va partir", "allons partir", "allez partir", "vont partir"], futurAnterieur: ["serai parti", "seras parti", "sera parti", "serons partis", "serez partis", "seront partis"] },
      Arriver: { present: ["arrive", "arrives", "arrive", "arrivons", "arrivez", "arrivent"], passeCompose: ["suis arriv√©", "es arriv√©", "est arriv√©", "sommes arriv√©s", "√™tes arriv√©s", "sont arriv√©s"], imparfait: ["arrivais", "arrivais", "arrivait", "arrivions", "arriviez", "arrivaient"], futurSimple: ["arriverai", "arriveras", "arrivera", "arriverons", "arriverez", "arriveront"], plusQueParfait: ["√©tais arriv√©", "√©tais arriv√©", "√©tait arriv√©", "√©tions arriv√©s", "√©tiez arriv√©s", "√©taient arriv√©s"], futurProche: ["vais arriver", "vas arriver", "va arriver", "allons arriver", "allez arriver", "vont arriver"], futurAnterieur: ["serai arriv√©", "seras arriv√©", "sera arriv√©", "serons arriv√©s", "serez arriv√©s", "seront arriv√©s"] }
    };

    // ------------------------------
    // UI generation
    const PRONOMS = [
      "Je",
      "Tu",
      "Il/Elle/On",
      "Nous",
      "Vous",
      "Ils/Elles"];

    const TIMES = [
      "present",
      "passeCompose",
      "imparfait",
      "futurSimple",
      "plusQueParfait",
      "futurProche",
      "futurAnterieur"
    ];
    const NOMBRE_BONITO = {
      present: "Pr√©sent",
      passeCompose: "Pass√© compos√©",
      imparfait: "Imparfait",
      futurSimple: "Futur simple",
      plusQueParfait: "Plus-que-parfait",
      futurProche: "Futur proche",
      futurAnterieur: "Futur ant√©rieur"
    };

    function createChips(containerId, items, type) {
      const cont = document.getElementById(containerId);
      items.forEach(it => {
        const d = document.createElement("div");
        d.className = "chip";
        d.dataset.value = it;
        d.textContent = NOMBRE_BONITO[it] || it;
        d.addEventListener("click", () => {
          d.classList.toggle("selected");
          toggleSelection(type, it, d.classList.contains("selected"));
        });
        cont.appendChild(d);
      });
    }

    function createVerbSelect() {
      const sel = document.getElementById("singleVerb");
      Object.keys(window.conjugations).forEach(v => {
        const o = document.createElement("option");
        o.value = v; o.textContent = v;
        sel.appendChild(o);
      });
    }

    // ------------------------------
    // selection state
    let selectedTensesAleatorio = new Set();
    let selectedVerbs = new Set();
    let selectedTensesIndividual = new Set();

    function toggleSelection(type, val, on) {
      if (type === "tenseA") { on ? selectedTensesAleatorio.add(val) : selectedTensesAleatorio.delete(val); }
      if (type === "verbs") { on ? selectedVerbs.add(val) : selectedVerbs.delete(val); }
      if (type === "tenseI") { on ? selectedTensesIndividual.add(val) : selectedTensesIndividual.delete(val); }
      updateStarts();
    }

    // ------------------------------
    // mode switching
    function showMode(mode) {
      document.getElementById("tab-ale").classList.toggle("active", mode === "aleatorio");
      document.getElementById("tab-ind").classList.toggle("active", mode === "individual");
      document.getElementById("aleatorioPanel").classList.toggle("hidden", mode !== "aleatorio");
      document.getElementById("individualPanel").classList.toggle("hidden", mode !== "individual");
      // hide exercise if switching while in setup
      document.getElementById("exerciseView").classList.add("hidden");
      document.getElementById("setupView").classList.remove("hidden");
      updateStarts();
    }

    // enable start buttons
    function updateStarts() {
      // enable/disable start buttons
      document.getElementById("startAleatorio").disabled = !(selectedTensesAleatorio.size > 0 && selectedVerbs.size > 0);
      const sel = document.getElementById("singleVerb").value;
      document.getElementById("startIndividual").disabled = !(sel && selectedTensesIndividual.size > 0);
      // show/hide clear (borrar) buttons based on whether there's any selection
      const clearAle = document.getElementById("clearAleatorio");
      if (clearAle) {
        const hasAnyAleSelection = (selectedTensesAleatorio.size > 0) || (selectedVerbs.size > 0);
        clearAle.classList.toggle('hidden', !hasAnyAleSelection);
      }
      const clearInd = document.getElementById("clearIndividual");
      if (clearInd) {
        const hasAnyIndSelection = (selectedTensesIndividual.size > 0) || !!sel;
        clearInd.classList.toggle('hidden', !hasAnyIndSelection);
      }
      // show/hide the INICIAR buttons based on required selections
      const startAle = document.getElementById("startAleatorio");
      if (startAle) {
        const showAle = (selectedTensesAleatorio.size > 0 && selectedVerbs.size > 0);
        startAle.classList.toggle('hidden', !showAle);
      }
      const startInd = document.getElementById("startIndividual");
      if (startInd) {
        const showInd = (!!sel && selectedTensesIndividual.size > 0);
        startInd.classList.toggle('hidden', !showInd);
      }
    }
    document.getElementById("singleVerb").addEventListener("change", updateStarts);

    // ------------------------------
    // Clear selected Chips in aleatorio and Individual modes
    function clearAleatorio() {
      selectedTensesAleatorio.clear();
      selectedVerbs.clear();
      // remove visual selection
      document.querySelectorAll("#tenseChips .chip, #verbChips .chip").forEach(el => el.classList.remove("selected"));
      // update start buttons
      updateStarts();
    }

    function clearIndividual() {
      // clear selected tenses and reset verb selector
      selectedTensesIndividual.clear();
      document.querySelectorAll("#individualTenseChips .chip").forEach(el => el.classList.remove("selected"));
      document.getElementById("singleVerb").value = "";
      updateStarts();
    }

    // ------------------------------
    // navigation: start, goBack
    window.questions = []; // <-- Added/Confirmed
    window.currentQuestion = 0; // <-- Added/Confirmed
    window.singleVerb = null;
    window.tensesList = [];
    window.currentTenseIndex = 0;

    function enterMode(mode) {
      // hide tabs and show banner and top back button
      var tabs = document.querySelector('.mode-tabs'); if (tabs) tabs.style.display = 'none';
      var banner = document.getElementById('aleModeBanner'); if (banner) { banner.style.display = 'block'; banner.textContent = mode === 'aleatorio' ? 'Modo Aleatorio' : 'Modo Individual'; }
      var banner = document.getElementById('indivModeBanner'); if (banner) { banner.style.display = 'block'; banner.textContent = mode === 'aleatorio' ? 'Modo Aleatorio' : 'Modo Individual'; }
      var topBack = document.getElementById('topBack'); if (topBack) topBack.style.display = 'flex';
    }

    function exitMode() {
      var tabs = document.querySelector('.mode-tabs'); if (tabs) tabs.style.display = 'inline-flex';
      var banner = document.getElementById('aleModeBanner'); if (banner) { banner.style.display = 'none'; banner.textContent = '' }
      var banner = document.getElementById('indivModeBanner'); if (banner) { banner.style.display = 'none'; banner.textContent = '' }
      var topBack = document.getElementById('topBack'); if (topBack) topBack.style.display = 'none';
    }

    function startAleatorio() {
      // build questions from selected sets
      window.questions = [];
      selectedVerbs.forEach(v => {
        selectedTensesAleatorio.forEach(t => {
          PRONOMS.forEach((p, i) => window.questions.push({ verb: v, tense: t, pronoun: p, index: i }));
        });
      });
      window.questions.sort(() => Math.random() - 0.5);
      window.currentQuestion = 0;
      document.getElementById("setupView").classList.add("hidden");
      document.getElementById("exerciseView").classList.remove("hidden");
      document.getElementById("aleatorioExercise").classList.remove("hidden");
      document.getElementById("individualExercise").classList.add("hidden");
      enterMode('aleatorio');
      showCurrentQuestion();
    }

    function startIndividual() {
      // ensure verb selected
      const sel = document.getElementById("singleVerb").value;
      if (!sel) return;
      // prepare tenses list
      window.singleVerb = sel;
      window.tensesList = Array.from(selectedTensesIndividual);
      window.currentTenseIndex = 0;
      document.getElementById("setupView").classList.add("hidden");
      document.getElementById("exerciseView").classList.remove("hidden");
      document.getElementById("aleatorioExercise").classList.add("hidden");
      document.getElementById("individualExercise").classList.remove("hidden");
      enterMode('individual');
      loadTense();
    }

    function goBack() {
      // hide exercise view and show setup again, keep selections intact
      document.getElementById("exerciseView").classList.add("hidden");
      document.getElementById("setupView").classList.remove("hidden");
      // reset exercise-specific UI
      document.getElementById("btnNext").classList.add("hidden");
      document.getElementById("btnNextIndividual").classList.add("hidden");
      exitMode();
    }

    // ------------------------------
    // ALEATORIO: SHOW QUESTIONS
    function showCurrentQuestion() {
      if (currentQuestion >= questions.length) {
        alert("¬°Has terminado el ejercicio!");
        goBack();
        return;
      }
      const q = questions[currentQuestion];

      // Set question and pronoun display
      document.getElementById("questionAleatorio").innerHTML =
        `<b>${q.verb}</b> / <b>${NOMBRE_BONITO[q.tense] || q.tense}</b>`;

      document.getElementById("pronounAleatorio").innerHTML =
        `<div class="pronomAl">${q.pronoun}&nbsp;&nbsp;_____</div>`;

      // Reset the input field and classes
      const ans = document.getElementById("answer");
      ans.value = "";
      ans.className = "input";

      // --- ADDED UI SETUP ---

      // SHOW CHECK BUTTON
      const btnCheck = document.getElementById("btnCheck");
      if (btnCheck) {
        btnCheck.classList.remove("hidden");
        btnCheck.disabled = true;
      }


      // HIDE NEXT BUTTON
      document.getElementById("btnNext").classList.add("hidden");
      // --- END ADDED UI SETUP ---
      setTimeout(function () {
        ans.focus();
      }, 0);
    }

    function clean(s) { return (s || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim(); }

    function checkAleatorio() {

      if (u === clean(expectedFormOnly) || u === clean(expectedWithPron)) {
        inp.classList.add("correct");

        // SHOW NEXT BUTTON
        document.getElementById("btnNext").classList.remove("hidden");

        // HIDE CHECK BUTTON
        document.getElementById("btnCheck").classList.add("hidden"); // <-- ADDED
      } else {
        inp.classList.add("wrong");
        document.getElementById("btnNext").classList.add("hidden");
        document.getElementById("btnCheck").classList.remove("hidden"); // <-- Ensure Check remains visible
      }
    }

    // ALEATORIO NEXT QUESTION 
    function nextAleatorio() {
      currentQuestion++;
      showCurrentQuestion();
    }

    // ALLOW ENTER ON NEXT
    function nextByEnterAleatorio() {
      const nextEnterAleatorio = document.getElementById('btnNext');
      nextEnterAleatorio.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          nextAleatorio();
        }
      });
    }

    // INDIVIDUAL: SHOW QUESTIONS
    function loadTense() {
      if (currentTenseIndex >= tensesList.length) {
        alert("¬°Has completado el ejercicio!");
        goBack();
        return;
      }

      const tense = tensesList[currentTenseIndex];

      // SET TITLE AND QUESTION FOR INDIVIDUAL
      document.getElementById("individualTitle").innerHTML =
        `<b>${singleVerb}</b> / <b>${NOMBRE_BONITO[tense] || tense}</b>`;

      let html = "";
      PRONOMS.forEach((p, i) => {

        html += ` <div class="pronom-row">
                  <div class="pronom">${p}:</div>
                  <input id="inputIndi" class="inputIndi" data-i="${i}" placeholder="" autocomplete="off"></div>`;
      });

      document.getElementById("pronomsList").innerHTML = html;
      document.getElementById("btnNextIndividual").classList.add("hidden");

      // CHECK BUTTON DISABLED INITIALLY
      const btnCheck = document.getElementById("btnCheckIndividual");
      if (btnCheck) {
        btnCheck.disabled = true;
      }

      // SET FOCUS ON INPUT AT START OF QUESTION
      setTimeout(function () {
        const firstInput = document.querySelector('#pronomsList input[data-i="0"]');
        if (firstInput) {
          firstInput.focus();
        }
      }, 0);

      const pronomsList = document.getElementById("pronomsList");
      if (pronomsList) {
      }
    }

    // Around line 1083: Corrected checkIndividualInputForColor function

    function checkIndividualInputForColor(event) {
      if (event.target.tagName !== 'INPUT') return;

      const inp = event.target;
      const userValue = inp.value.trim();

      // 1. Determine correctness (Minimal check needed for dynamic color)
      const i = parseInt(inp.getAttribute('data-i'));
      const tense = getCurrentTense();
      const verb = getVerb();
      var correct = getConj(verb, tense, i) || '';
      var u = norm(userValue);

      var isCorrect = u === norm(correct);

      inp.classList.remove('wrongIndi');

      if (userValue !== '' && isCorrect) {
        inp.classList.add('correctIndi');
      } else {
        setTimeout(() => {
          inp.classList.remove('correctIndi');
        }, 0);
      }

      // --- 2. MANAGE CHECK BUTTON DISABLED STATE ---
      var inputs = Array.from(document.querySelectorAll('#pronomsList input'));
      var anyInputHasValue = inputs.some(inp => inp.value.trim() !== '');
      var btnCheck = document.getElementById('btnCheckIndividual');
      var next = document.getElementById('btnNextIndividual'); // <-- Get Next button reference

      if (btnCheck) {
        btnCheck.disabled = !anyInputHasValue;
      }

      if (next) {
        next.classList.add('hidden');
      }
      if (btnCheck) {
        btnCheck.classList.remove('hidden');
      }

    }

    function updateAleatorioCheckButton() {
      const btnCheck = document.getElementById("btnCheck");
      const btnNext = document.getElementById("btnNext");
      const ans = document.getElementById("answer");
      const q = getCurrentQuestion();

      if (!btnCheck || !btnNext || !ans || !q) return;

      ans.classList.remove('correct', 'wrong');

      const userValue = ans.value || "";
      const hasInput = userValue.trim().length > 0;
      const isCorrect = isAleatorioAnswerCorrect(q, userValue);

      if (hasInput && isCorrect) {
        ans.classList.add('correct');
      }
      else {
        btnNext.classList.add("hidden");
        btnCheck.classList.remove("hidden");
      }
      if (hasInput) {
        btnCheck.classList.remove("hidden");
        btnCheck.disabled = false;
      }
      else {
        btnCheck.disabled = !hasInput;
      }
      btnNext.classList.add("hidden");
    }

    function nextIndividual() {
      currentTenseIndex++;
      loadTense();
    }

    function getCurrentTense() {
      return window.tensesList ? window.tensesList[window.currentTenseIndex] : null;
    }

    function getVerb() {
      return window.singleVerb || null;
    }

    function getCurrentQuestion() {
      return window.questions ? window.questions[window.currentQuestion] : null;
    }

    function getCurrentQuestionPronoun() {
      const q = getCurrentQuestion();
      return q ? q.pronoun : null;
    }
    document.addEventListener('DOMContentLoaded', function () {
      // Chips Generation
      createChips("tenseChips", TIMES, "tenseA");
      createChips("verbChips", Object.keys(window.conjugations), "verbs");
      createChips("individualTenseChips", TIMES, "tenseI");
      createVerbSelect();
      updateStarts();
    });

    'use strict';
    // normalize string: remove diacritics and collapse whitespace, lowercase
    function norm(s) { return (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim(); }

    // robust getter: accepts array-shaped or object-shaped conjugations
    function getConj(verb, tense, pronIndex) {
      try {
        if (!verb || !tense) return '';
        var root = window.conjugations && window.conjugations[verb];
        if (!root) return '';
        var block = root[tense] || root[tense.toLowerCase()] || root[tense.replace(/\s+/g, ' ')] || root[tense];
        if (!block) return '';
        if (Array.isArray(block)) {
          var idx = Number(pronIndex) || 0;
          return block[idx] || '';
        }

        var keys = ['je', 'tu', 'il', 'nous', 'vous', 'ils'];
        var idx = Number(pronIndex);
        if (!isNaN(idx) && keys[idx]) {
        }
        if (typeof pronIndex === 'string' && block[pronIndex] !== undefined) return block[pronIndex];
        return '';
      } catch (e) { console.error('getConj error', e); return ''; }
    }

    window.getConj = getConj;

    function isAleatorioAnswerCorrect(q, userValue) {
      if (!q || !userValue) return false;

      // INPUT ACCEPTS  FLEXIBILITY ON ANSWERS
      var correct = getConj(q.verb, q.tense, q.index) || '';
      var u = norm(userValue);
      var acceptedAnswers = [];
      acceptedAnswers.push(norm(correct));

      // ACCEPT 3RD FORM SINGULAR & PLURAL INDEPENDENT PRONOUNS
      var pronounList = [];
      if (q.pronoun === "Il/Elle/On") {
        pronounList = ["il", "elle", "on"];
      } else if (q.pronoun === "Ils/Elles") {
        pronounList = ["ils", "elles"];
      } else {
        pronounList = [norm(q.pronoun)];
      }

      pronounList.forEach(p => {
        acceptedAnswers.push(p + ' ' + norm(correct));
      });

      return acceptedAnswers.includes(u);
    }

    window.revealAleatorio = function () {
      try {
        var q = window.getCurrentQuestion();

        if (!q) {
          console.error("No current question found for Aleatorio mode. Ensure a question is visible.");
          return;
        }

        var correct = getConj(q.verb, q.tense, q.index) || '';
        var ansEl = document.getElementById('answer');

        // Reveal the correct answer
        ansEl.value = correct;
        ansEl.classList.add("correct");
        ansEl.classList.remove("wrong");

        // Cleanup: Hide the check button
        var btnCheck = document.getElementById('btnCheck');
        if (btnCheck) btnCheck.classList.add('hidden');

        // Show the Next button
        var next = document.getElementById('btnNext');
        if (next) next.classList.remove('hidden');

      } catch (e) {
        console.error('revealAleatorio error', e);
      }
    };

    window.revealIndividual = function () {
      try {
        var tense = window.getCurrentTense();
        var verb = window.getVerb();
        if (!tense || !verb) return;

        var inputs = Array.from(document.querySelectorAll('#pronomsList input'));
        var btnCheck = document.getElementById('btnCheckIndividual');
        var btnNext = document.getElementById('btnNextIndividual');

        inputs.forEach(function (inp, i) {
          var correct = window.getConj(verb, tense, i) || '';

          inp.value = correct;
          inp.classList.add('correctIndi');
          inp.classList.remove('wrongIndi');
        });

        if (btnCheck) {
          btnCheck.disabled = true;
          btnCheck.classList.add('hidden');
        }

        if (btnNext) {
          setTimeout(() => {
            btnNext.classList.remove('hidden');
            btnNext.focus();
          }, 0);
        }
      } catch (e) {
        console.error('revealIndividual error', e);
      }
    };

    window.checkAleatorio = function () {
      try {
        var q = getCurrentQuestion();
        if (!q) return;

        var ansEl = document.getElementById('answer');
        var user = ansEl.value || "";

        ansEl.classList.remove("correct", "wrong");

        var isCorrect = isAleatorioAnswerCorrect(q, user);
        var hasInput = user.trim().length > 0;

        if (isCorrect) {
          ansEl.classList.add("correct");
          document.getElementById("btnNext").classList.remove("hidden");
          document.getElementById("btnCheck").classList.add("hidden");
          setTimeout(() => {
            document.getElementById('btnNext').focus();
          }, 50);

        } else if (hasInput) {
          ansEl.classList.add("wrong");

        }
      } catch (e) {
        console.error('checkAleatorio error', e);
      }
    };

    window.checkIndividual = function () {
      try {
        var tense = getCurrentTense(); if (!tense) return;
        var verb = getVerb(); if (!verb) return;
        var inputs = Array.from(document.querySelectorAll('#pronomsList input'));
        var btnCheck = document.getElementById('btnCheckIndividual');
        var next = document.getElementById('btnNextIndividual');

        var allTenseInputsCompleteAndCorrect = true;
        var anyInputHasValue = false;
        var firstFocusCandidate = null;

        var isExplicitCheck = !inputs.includes(document.activeElement);

        inputs.forEach(function (inp, i) {
          var correct = getConj(verb, tense, i) || '';
          var userValue = inp.value.trim();
          var u = norm(userValue);

          const PRONOUN_GROUPS = [["je"], ["tu"], ["il", "elle", "on"], ["nous"], ["vous"], ["ils", "elles"]];
          var acceptedAnswers = [norm(correct)];
          pronounList = PRONOUN_GROUPS[i] || [];
          pronounList.forEach(p => { acceptedAnswers.push(p + ' ' + norm(correct)); });
          var isCorrect = acceptedAnswers.includes(u);

          if (userValue !== '') {
            anyInputHasValue = true;
          }

          if (userValue === '' || !isCorrect) {
            allTenseInputsCompleteAndCorrect = false;
            if (!firstFocusCandidate) {
              firstFocusCandidate = inp;
            }
          }

          if (userValue !== '') {
            if (isCorrect) {
              inp.classList.add('correctIndi');
            } else {
              inp.classList.add('wrongIndi');
            }
          }
        });


        // --- FINAL BUTTON & FOCUS MANAGEMENT ---
        if (allTenseInputsCompleteAndCorrect) {
          if (btnCheck) btnCheck.disabled = true;
        } else {

          if (btnCheck) btnCheck.disabled = !anyInputHasValue;

          var isAnInputFocused = inputs.includes(document.activeElement);
          if (isExplicitCheck && !isAnInputFocused && firstFocusCandidate) {
            firstFocusCandidate.focus();
          }
        }
      } catch (e) {
        console.error('checkIndividual error', e);
      }
    };


    document.addEventListener('DOMContentLoaded', function () {
      try {
        // --- ALEATORIO BINDINGS ---
        var ans = document.getElementById('answer');
        if (ans) {
          ans.addEventListener('input', updateAleatorioCheckButton);
          ans.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
              e.preventDefault();

              const nextButton = document.getElementById('btnNext');

              if (nextButton && !nextButton.classList.contains('hidden')) {
                // --- ACTION 2 (Next Question) ---
                window.nextAleatorio();
                ans.blur();

              } else {
                window.checkAleatorio();
              }
            }
          });
        }

        var btnCheck = document.getElementById('btnCheck');
        if (btnCheck) {
          btnCheck.addEventListener('click', window.checkAleatorio);
        }

        var btnRevealAleatorio = document.getElementById('btnRevealAleatorio');
        if (btnRevealAleatorio) {
          btnRevealAleatorio.removeAttribute('onclick');
          btnRevealAleatorio.addEventListener('click', window.revealAleatorio);
        }

        // --- INDIVIDUAL BINDINGS ---
        var btnRevealIndividual = document.getElementById('btnRevealIndividual');
        if (btnRevealIndividual) {
          btnRevealIndividual.addEventListener('click', window.revealIndividual);
        }

        var btnCheckIndividual = document.getElementById('btnCheckIndividual');
        if (btnCheckIndividual) {
          btnCheckIndividual.removeAttribute('onclick');
          btnCheckIndividual.addEventListener('click', function () {
            window.checkIndividual();
            if (btnCheckIndividual.disabled) {
              var btnNext = document.getElementById('btnNextIndividual');
              if (btnNext) {
                setTimeout(() => {
                  btnNext.classList.remove('hidden');
                  btnCheckIndividual.classList.add('hidden');
                  btnNext.focus();
                }, 50);
              }
            } else {
              var btnNext = document.getElementById('btnNextIndividual');
              if (btnNext) btnNext.classList.add('hidden');
            }
          });
        }


        var btnNextIndividual = document.getElementById('btnNextIndividual');
        if (btnNextIndividual) {
          btnNextIndividual.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              window.nextIndividual();
            }
          });
        }

        var pronomsList = document.getElementById('pronomsList');
        if (pronomsList) {
          pronomsList.addEventListener('input', checkIndividualInputForColor);
          pronomsList.addEventListener('keydown', function (e) {
            if (e.target.tagName === 'INPUT' && e.key === 'Enter') {
              e.preventDefault();
              var inputs = Array.from(document.querySelectorAll('#pronomsList input'));
              var focusedIndex = inputs.indexOf(e.target);
              var btnNext = document.getElementById('btnNextIndividual');
              var btnCheck = document.getElementById('btnCheckIndividual');


              if (btnNext && !btnNext.classList.contains('hidden')) {
                window.nextIndividual();
                return;
              }

              window.checkIndividual();
              if (btnCheck.disabled) {
                if (btnNext) {
                  btnNext.classList.remove('hidden');
                  btnCheck.classList.add('hidden');
                  btnNext.focus();
                }
              } else if (focusedIndex !== -1) {
                var currentInputIsCorrect = e.target.classList.contains('correctIndi');

                if (currentInputIsCorrect && focusedIndex < inputs.length - 1) {
                  inputs[focusedIndex + 1].focus();
                } else {
                  e.target.blur();
                }
              }
            }
          });
        }
      } catch (e) { console.error('binding error', e); }
    });


  </script>

  <script>
  </script>

</body>

</html>